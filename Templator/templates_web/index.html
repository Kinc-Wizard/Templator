{{ define "title" }}Templator - Generate Payload{{ end }}

{{ define "content" }}
<div class="card">
    <form action="/upload" method="post" enctype="multipart/form-data">
        <div class="field">
            <label class="label">Shellcode File</label>
            <div class="control">
                <input class="input" type="file" name="shellcode" required>
            </div>
        </div>

        <div class="field">
            <label class="label">Template</label>
            <div class="control template-select-container">
                <div class="select">
                    <select name="template" id="template">
                        {{ if .Templates }}
                            {{ $currentLang := "" }}
                            {{ range .Templates }}
                                {{ if ne $currentLang .Language }}
                                    {{ if ne $currentLang "" }}
                                        </optgroup>
                                    {{ end }}
                                    <optgroup label="{{ .Language }}">
                                    {{ $currentLang = .Language }}
                                {{ end }}
                                <option value="{{ .Name }}" 
                                        data-needs-process="{{.NeedsProcess}}" 
                                        data-needs-process-path="{{.NeedsProcessPath}}"
                                        data-supports-obfuscation="{{.SupportsObfuscation}}"
                                        data-support-encryption="{{.SupportEncryption}}"
                                        data-language="{{.Language}}"
                                        data-details="{{.Description}}">
                                    {{ .Name }}
                                </option>
                            {{ end }}
                            </optgroup>
                        {{ end }}
                    </select>
                </div>
                <span class="info-icon" onclick="showTemplateInfo()">ℹ️</span>
            </div>
        </div>

        <div class="field" id="process_name_field" style="display:none;">
            <label class="label">Process Name</label>
            <div class="control">
                <input class="input" type="text" name="process_name" placeholder="Enter process name (e.g. notepad.exe)">
            </div>
        </div>

        <div class="field" id="process_path_field" style="display:none;">
            <label class="label">Process Path</label>
            <div class="control">
                <input class="input" type="text" id="process_path_input" name="process_path" placeholder="Enter full process path (e.g. C:\\Windows\\System32\\notepad.exe)">
                <p class="help is-danger" id="process_path_error" style="display:none;">Le chemin doit contenir des doubles backslashes (\\)</p>
            </div>
        </div>

        <div class="field">
            <label class="label">Architecture</label>
            <div class="control">
                <div class="select">
                    <select name="arch">
                        <option value="x86">x86 (32-bit)</option>
                        <option value="x64">x64 (64-bit)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Ligne de séparation -->
        <hr class="has-background-grey-lighter" style="opacity: 0.2; margin: 1.5rem 0;">

        <div class="field obfuscator-section" style="display:none;">
            <label class="label">Obfuscator</label>
            <div class="control">
                <label class="checkbox">
                    <input type="checkbox" name="ep_obfuscator">
                    EP Obfuscator
                </label>
            </div>
        </div>

        <div class="field encryption-section" style="display:none;">
            <label class="label">Encryption</label>
            <div class="control">
                <label class="checkbox">
                    <input type="checkbox" name="aes_encryption">
                    AES Encryption
                </label>
            </div>
        </div>

        <div class="field">
            <div class="control">
                <button class="button is-hack" type="submit">Generate PE</button>
            </div>
        </div>

        <input type="hidden" name="language" value="">
    </form>
</div>

<!-- Ajouter la modale -->
<div id="templateInfoModal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Template Details</p>
            <button class="delete" aria-label="close" onclick="closeTemplateInfo()"></button>
        </header>
        <section class="modal-card-body">
            <pre id="templateDetails"></pre>
        </section>
    </div>
</div>

<div class="card" style="margin-top: 2rem;">
    <div class="is-flex is-justify-content-space-between is-align-items-center" style="margin-bottom: 1rem;">
        <h2 class="title is-5">Terminal</h2>
        <button class="button is-hack is-small" onclick="clearTerminal()">Clear</button>
    </div>
    <div class="content">
        <pre id="terminal" style="height: 200px; overflow-y: auto; background: #1a1a1a; color: #00ff00; padding: 10px;"></pre>
    </div>
</div>

<div style="margin-top: 2rem;">
    <a href="/downloads" class="has-text-primary">→ View Generated Payloads</a>
</div>

<script>
function updateTemplateUI() {
    const select = document.getElementById('template');
    const selectedOption = select.options[select.selectedIndex];
    const details = selectedOption.getAttribute('data-details');
    const language = selectedOption.getAttribute('data-language');
    document.getElementById('templateDetails').textContent = details;
    document.querySelector('input[name="language"]').value = language;
    
    // Gérer l'affichage des champs conditionnels
    const needsProcess = selectedOption.getAttribute('data-needs-process') === 'true';
    const needsProcessPath = selectedOption.getAttribute('data-needs-process-path') === 'true';
    
    document.getElementById('process_name_field').style.display = needsProcess ? 'block' : 'none';
    document.getElementById('process_path_field').style.display = needsProcessPath ? 'block' : 'none';
    
    const supportsObfuscation = selectedOption.getAttribute('data-supports-obfuscation') === 'true';
    document.querySelector('.obfuscator-section').style.display = supportsObfuscation ? 'block' : 'none';
    
    const supportEncryption = selectedOption.getAttribute('data-support-encryption') === 'true';
    document.querySelector('.encryption-section').style.display = supportEncryption ? 'block' : 'none';
}

document.getElementById('template').addEventListener('change', updateTemplateUI);

// Valider le format du chemin du processus
document.addEventListener('input', function(e) {
    if (e.target.id === 'process_path_input') {
        const input = e.target;
        const errorElement = document.getElementById('process_path_error');
        const submitButton = document.querySelector('button[type="submit"]');
        
        // Remplacer les simples backslashes par des doubles backslashes
        let value = input.value;
        let fixedValue = value.replace(/([^\\])\\([^\\])/g, '$1\\\\$2');
        
        // Si la valeur a été modifiée, mettre à jour le champ
        if (fixedValue !== value) {
            input.value = fixedValue;
        }
        
        // Vérifier si le format est correct (au moins un double backslash)
        if (fixedValue.includes('\\\\')) {
            errorElement.style.display = 'none';
            submitButton.disabled = false;
        } else {
            errorElement.style.display = 'block';
            submitButton.disabled = true;
        }
    }
});

// Exécuter au chargement de la page pour le template sélectionné par défaut
window.addEventListener('DOMContentLoaded', updateTemplateUI);

document.getElementById('template').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const details = selectedOption.getAttribute('data-details');
    const language = selectedOption.getAttribute('data-language');
    
    // Mettre à jour les détails
    document.getElementById('templateDetails').textContent = details;
    
    // Mettre à jour le champ caché du langage
    document.querySelector('input[name="language"]').value = language;
    
    // Gérer l'affichage des champs conditionnels
    const needsProcess = selectedOption.getAttribute('data-needs-process') === 'true';
    const needsProcessPath = selectedOption.getAttribute('data-needs-process-path') === 'true';
    
    document.getElementById('process_name_field').style.display = needsProcess ? 'block' : 'none';
    document.getElementById('process_path_field').style.display = needsProcessPath ? 'block' : 'none';

    // Gérer l'affichage de la section obfuscator
    const supportsObfuscation = selectedOption.getAttribute('data-supports-obfuscation') === 'true';
    document.querySelector('.obfuscator-section').style.display = supportsObfuscation ? 'block' : 'none';

    // Gérer l'affichage de la section encryption
    const supportEncryption = selectedOption.getAttribute('data-support-encryption') === 'true';
    document.querySelector('.encryption-section').style.display = supportEncryption ? 'block' : 'none';
});

function showTemplateInfo() {
    const select = document.getElementById('template');
    const option = select.options[select.selectedIndex];
    const details = option.getAttribute('data-details');
    document.getElementById('templateDetails').textContent = details;
    document.getElementById('templateInfoModal').classList.add('is-active');
}

function closeTemplateInfo() {
    document.getElementById('templateInfoModal').classList.remove('is-active');
}

const terminal = document.getElementById('terminal');
const ws = new WebSocket('ws://' + window.location.host + '/ws/terminal');

ws.onmessage = function(event) {
    const message = event.data;
    terminal.innerHTML += message + '\n';
    terminal.scrollTop = terminal.scrollHeight;
};

// Fonction pour envoyer des événements au serveur
function sendEvent(event) {
    if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(event));
    }
}

// Écouteurs d'événements pour les changements d'interface
document.getElementById('template').addEventListener('change', function() {
    const selectedTemplate = this.options[this.selectedIndex].text;
    sendEvent({
        type: 'template_change',
        template: selectedTemplate
    });
});

document.querySelector('select[name="arch"]').addEventListener('change', function() {
    const selectedArch = this.value;
    sendEvent({
        type: 'arch_change',
        arch: selectedArch
    });
});

document.querySelector('form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Ajouter un message de succès sans recharger la page
            const message = document.createElement('div');
            message.className = 'notification is-success';
            message.textContent = data.message;
            document.querySelector('.card').prepend(message);
            
            // Faire disparaître le message après 5 secondes
            setTimeout(() => {
                message.remove();
            }, 5000);
        }
    });
});

function clearTerminal() {
    // Nettoyer l'affichage local
    document.getElementById('terminal').innerHTML = '';
    
    // Envoyer une commande de nettoyage au serveur
    sendEvent({
        type: 'clear_terminal'
    });
}
</script>
{{ end }}
